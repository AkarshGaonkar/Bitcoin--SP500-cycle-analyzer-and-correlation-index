name: Update data and visualizations

on:
  schedule:
    - cron: "0 6 * * *"  # runs daily at 6:00 UTC (~1 AM EST)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup R
        uses: r-lib/actions/setup-r@v2

      - name: Install packages
        run: |
          Rscript -e "install.packages(c('tidyverse','httr','readr','lubridate'))"

      - name: Run update script
        run: |
          Rscript scripts/update_data.R

      - name: Run analysis script
        run: |
          Rscript scripts/analysis.R

      - name: Update README with latest PNGs
        run: |
          PNG_FILES=$(find . -name "*.png" -type f)

          if [ -z "$PNG_FILES" ]; then
            echo "No PNG files found"
            exit 0
          fi

          cat > README_temp.md << 'EOF'
          # Daily BTC/SP500 Analysis

          ## Overview
          This project analyzes how Bitcoin and the S&P 500 move together over time using two web-based data sources that update daily.
          Bitcoin prices come from a public cryptocurrency API that provides daily open, high, low, close and volume in U.S. dollars, while S&P 500 index levels are downloaded as CSV files from a free market data provider that publishes historical daily prices for major equity indices.

          Tracking both series together gives a current picture of how tightly Bitcoin is linked to the broad U.S. equity market.

          ## Automated data pipeline
          A GitHub Actions workflow runs once per day. It pulls any new observations, appends them to the CSV files, then refreshes the charts.
          The pipeline:
          - downloads new daily data
          - updates CSVs incrementally
          - cleans dates and computes returns
          - calculates a rolling 250-day correlation

          ## Visualizations
          Three time series charts are included:
          - Bitcoin cumulative return (per year)
          - S&P 500 cumulative return (per year)
          - Rolling 250-day correlation between the two assets

          ## Interpretation
          Rising lines show periods of gains, falling lines show losses.
          Correlation values near +1 mean the two markets move together.
          Low correlation means weak comovement.

          ## Plots
          EOF

          # append image markdown
          for FILE in $PNG_FILES; do
            NAME=$(basename "$FILE")
            echo "" >> README_temp.md
            echo "![]($NAME)" >> README_temp.md
          done

          # move into place
          mv README_temp.md README.md

      - name: Commit and push
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          git add README.md data/*.csv plots/*.png || true

          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "Daily update: $(date)"
          git push
